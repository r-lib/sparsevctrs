<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sparsevctrs">
<title>When to use sparse vectors • sparsevctrs</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="When to use sparse vectors">
<meta property="og:description" content="sparsevctrs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="sparsevctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">sparsevctrs</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/design.html">Design behind sparsevctrs</a>
    <a class="dropdown-item" href="../articles/when-to-use.html">When to use sparse vectors</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/sparsevctrs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>When to use sparse vectors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/sparsevctrs/blob/HEAD/vignettes/articles/when-to-use.Rmd" class="external-link"><code>vignettes/articles/when-to-use.Rmd</code></a></small>
      <div class="d-none name"><code>when-to-use.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/sparsevctrs" class="external-link">sparsevctrs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lobstr.r-lib.org/" class="external-link">lobstr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The sparse vectors created with this package will act as a drop-in
replacement for dense vectors in any workflow. You will not see a memory
penalty for doing this. This is happening because non-compatible
operations will simply materialize the full vector and it would behave
as if you didn’t create it sparse to begin with.</p>
<p>This is generally the truth, but there are some cases where it isn’t.
This article will lay out when and how you can use sparse vectors for
the best performance possible.</p>
<p>To aid users in determining whether the code is not dropping the
sparsity, the option <code>sparsevctrs.verbose_materialize</code> can be
set to alert the user that a sparse vector was forced to
materialize.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"sparsevctrs.verbose_materialize"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="base-size-of-objects">Base size of objects<a class="anchor" aria-label="anchor" href="#base-size-of-objects"></a>
</h2>
<p>One of the differences between sparse and dense vectors is how much
memory they take up. This value is computed as an offset plus a linear
effect based on the number of values.</p>
<p>An integer vector of length 0 takes up <code>48 B</code> to exist.
Each additional value adds another <code>4 B</code> on average. This
effect is linear, so an integer vector with 1000 elements takes up
<code>48 B + 1000 * 4 B = 4048 B</code>, an integer vector with 2000
elements takes up <code>48 B + 2000 * 4 B = 8048 B</code> and so on.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 48 B</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4.05 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 8.05 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 12.05 kB</span></span></code></pre></div>
<p>The vectors above only contained the value <code>0</code>. We can
replicate that sparsely with
<code>sparse_integer(integer(), integer(), length = 0)</code>. We see
that the size of a 0-length sparse integer vector has a size of
<code>1304 B = 1.3 kB</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
<p>This value is the same for any size of sparse vector, regardless of
how long it is. This is happening because the sparse vectors only keep
track of the non-default values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">3000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="keeping-dense-data-in-a-sparse-format">Keeping dense data in a sparse format<a class="anchor" aria-label="anchor" href="#keeping-dense-data-in-a-sparse-format"></a>
</h2>
<p>A dense integer vector will have the same size, regardless of what
values it takes</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">dense_x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4.05 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dense_x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">dense_x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4.05 kB</span></span></code></pre></div>
<p>The sparse integer counterpart on the other hand will increase for
each non-default we need to store.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.30 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2.49 kB</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_integer.html">sparse_integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2.89 kB</span></span></code></pre></div>
<p>So it all comes down to a trade-off. Dense integer vectors with a
size of 313 or less will be smaller than their sparse counterparts no
matter what. Dense integer vector vectors with 314 elements will take up
the same amount of memory as their sparse counterpart with no
values.</p>
<p>From these values we can calculate memory equivalent vectors to
determine which would be more efficient, noting that sparse vectors
increase in size by twice for each non-default value that their dense
counterpart. For a vector of length 1000, the sparse vector will be
equivalent in size if it has <code>343</code> non-default values. And
these values continue to go up.</p>
</div>
<div class="section level2">
<h2 id="conversion-speed">Conversion speed<a class="anchor" aria-label="anchor" href="#conversion-speed"></a>
</h2>
<p>As with everything in life, we have to deal with tradeoffs. The main
tradeoff you will see in using this package is that memory allocation is
minimized to allow for workflows not otherwise possible. With that in
mind, there will be times when using these sparse vectors is not ideal.
The main one is that converting back and forth between dense and sparse
vectors takes a non-zero amount of time. Generally, you won’t see any
benefit if you are forced to materialize a sparse vector.</p>
<p>Below is one such example. both <code>dense_fun()</code> and
<code>sparse_fun()</code> creates a numeric vector, with length
<code>x</code>, with the value of <code>x</code> in the last element.
Calling <code>[]</code> on an ALTREP vector forces it to materialize, so
we now can look at how much slower it is to create the sparse vector and
go back.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="va">x</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_double.html">sparse_double</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/press.html" class="external-link">press</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">10000000</span><span class="op">)</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>      dense <span class="op">=</span> <span class="fu">dense_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>      sparse <span class="op">=</span> <span class="fu">sparse_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="when-to-use_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>staying dense the whole time is faster no matter the speed.</p>
<p>As a comparison, we can look at how much time it takes if we don’t
force materialization.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="va">x</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_double.html">sparse_double</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/press.html" class="external-link">press</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">10000000</span><span class="op">)</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>      dense <span class="op">=</span> <span class="fu">dense_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>      sparse <span class="op">=</span> <span class="fu">sparse_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="when-to-use_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>What we are really seeing here is that creating a sparse vector takes
a near-constant amount of time. So once the length is high enough it
wins. But this by itself isn’t a good comparison because these vectors
are useless unless we do something with them. Where sparse vectors shine
is when we can use sparse-aware methods. One such example are
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code> and <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code> for
numeric ALTREP vectors. These functions have special hooks to trigger
implementations that don’t require materialization. They will thus do
quite well.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="va">x</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_double.html">sparse_double</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/press.html" class="external-link">press</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">10000000</span><span class="op">)</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">dense_x</span> <span class="op">&lt;-</span> <span class="fu">dense_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu">sparse_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>      dense <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dense_x</span><span class="op">)</span>,</span>
<span>      sparse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="when-to-use_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>These functions do well because they calculate the sum over the
non-default values instead of all values. For truly sparse vectors this
will be fast. On the other hand, some methods don’t have ALTREP support.
Trying to use them triggers materialization to allow the calculations to
progress. Once such unsupported method is <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="va">x</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_double.html">sparse_double</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/press.html" class="external-link">press</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">10000000</span><span class="op">)</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">dense_x</span> <span class="op">&lt;-</span> <span class="fu">dense_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu">sparse_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>      dense <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dense_x</span><span class="op">)</span>,</span>
<span>      sparse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="when-to-use_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>And we see that the sparse is always slower. But this can be handled
by doing sparse-aware calculations. The helper functions
<code><a href="../reference/extractors.html">sparse_positions()</a></code> and <code><a href="../reference/extractors.html">sparse_values()</a></code> can be
used in combination with other functions to work with sparse vectors
without having to materialize them. Under the assumption that
<code>default = 0</code>, we can write a mean method for sparse vectors
as <code>sum(sparse_values(x)) / length(x)</code>. Using this
formulation allows us to work fast again by avoiding
materialization.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="va">x</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparse_double.html">sparse_double</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sparse_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/extractors.html">sparse_values</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/press.html" class="external-link">press</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">100000</span>, <span class="fl">1000000</span>, <span class="fl">10000000</span><span class="op">)</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">dense_x</span> <span class="op">&lt;-</span> <span class="fu">dense_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">sparse_x</span> <span class="op">&lt;-</span> <span class="fu">sparse_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>      dense <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dense_x</span><span class="op">)</span>,</span>
<span>      sparse <span class="op">=</span> <span class="fu">sparse_mean</span><span class="op">(</span><span class="va">sparse_x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="when-to-use_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The ideal usage of sparse vectors is to keep them in a data.frame or
tibble, and use <code><a href="../reference/coerce_to_sparse_matrix.html">coerce_to_sparse_matrix()</a></code> at the end to
create a sparse matrix that is understood by downstream functions.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

  </div></footer>
</body>
</html>
