<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Design behind sparsevctrs • sparsevctrs</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design behind sparsevctrs">
<meta name="robots" content="noindex">
<script defer data-domain="sparsevctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sparsevctrs</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/design.html">Design behind sparsevctrs</a></li>
    <li><a class="dropdown-item" href="../articles/when-to-use.html">When to use sparse vectors</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/sparsevctrs/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Design behind sparsevctrs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/sparsevctrs/blob/main/vignettes/design.Rmd" class="external-link"><code>vignettes/design.Rmd</code></a></small>
      <div class="d-none name"><code>design.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/sparsevctrs" class="external-link">sparsevctrs</a></span><span class="op">)</span></span></code></pre></div>
<p>The sparsevctrs package produces 3 things; ALTREP classes,
matrix/data.frame converting functions, helper functions. This document
outlines the rationale behind each of these and the decisions behind
them.</p>
<p>The primary objective of this package is to provide tools to work
with sparse data in data.frames/tibbles. The next highest priority is
execution speed. This means that algorithms and methods in this package
are written to minimize memory allocations whenever possible, once that
is done, running the code as fast as we can. These choices are made
because this package was written to deal with tasks that were otherwise
not possible due to memory constraints.</p>
<div class="section level2">
<h2 id="altrep-functions">Altrep Functions<a class="anchor" aria-label="anchor" href="#altrep-functions"></a>
</h2>
<p>The functions <code><a href="../reference/sparse_double.html">sparse_double()</a></code> and its relatives are used
to construct sparse vectors of the noted type. To work they all need 4
pieces of information:</p>
<ul>
<li><code>values</code></li>
<li><code>positions</code></li>
<li><code>length</code></li>
<li>
<code>default</code> (defaults to 0)</li>
</ul>
<p>The values need to match the type of the function name or be easily
coerced into the type (double -&gt; integer). The positions should be
integers or doubles that can losslessly be turned into integers. The
length should be a single non-negative integer-like value.</p>
<p>Values and positions are paired, and will thus be expected to be the
same length, furthermore, positions are expected to be sorted in
increasing order with no duplicates. The ordering is done to let the
various extraction methods work as efficiently as possible.</p>
<p>These functions have quite strict input checking by choice, to allow
the inner workings to be as efficient as possible.</p>
<p>The input of these functions mirrors the values stored in the ALTREP
class that they produce.</p>
</div>
<div class="section level2">
<h2 id="converting-functions">Converting Functions<a class="anchor" aria-label="anchor" href="#converting-functions"></a>
</h2>
<p>3 functions fall into this category:</p>
<ul>
<li><code><a href="../reference/coerce_to_sparse_data_frame.html">coerce_to_sparse_data_frame()</a></code></li>
<li><code><a href="../reference/coerce_to_sparse_tibble.html">coerce_to_sparse_tibble()</a></code></li>
<li><code><a href="../reference/coerce_to_sparse_matrix.html">coerce_to_sparse_matrix()</a></code></li>
</ul>
<p>the first two take a sparse matrix from the Matrix package and
produce a data.frame/tibble with sparse columns. The last one takes a
data.frame/tibble with sparse columns and produces a sparse matrix using
the Matrix package.</p>
<p>These functions are expected to be inverse of each other, such that
<code>coerce_to_sparse_matrix(coerce_to_sparse_data_frame(x))</code>
returns <code>x</code> back. They are made to be highly performant both
in terms of speed and memory consumption, Meaning that sparsity is
applied when appropriate.</p>
<p>These functions have quite strict input checking by choice, to allow
the inner workings to be as efficient as possible. It is in part why
data.frames with sparse vectors with different can’t be used with
<code><a href="../reference/coerce_to_sparse_matrix.html">coerce_to_sparse_matrix()</a></code> yet.</p>
</div>
<div class="section level2">
<h2 id="helper-functions">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h2>
<p>There are 3 types of helper functions. First, we have the
<code>is_*</code> family of functions. The specific
<code><a href="../reference/type-predicates.html">is_sparse_double()</a></code> and more general
<code><a href="../reference/type-predicates.html">is_sparse_vector()</a></code> can be used as a way to determine
whether a vector is an ALTREP sparse vector. This is otherwise hard to
tell as <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code> can’t tell the difference.</p>
<p>Secondly, we have the extraction functions. They are
<code><a href="../reference/extractors.html">sparse_values()</a></code> and <code><a href="../reference/extractors.html">sparse_positions()</a></code>. These
extract the values and positions respectively, without materializing the
whole dense vector. These functions are made to work with non-sparse
vectors as well to make them more ergonomic for the user. Internally
they call <code><a href="../reference/type-predicates.html">is_sparse_vector()</a></code>, so the choice to return
something useful as the alternative wasn’t hard. There is no
<code>sparse_length()</code> function as <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code> works
with these types of</p>
<p>The last type of helper function is less clearly defined and is
expanded as needed. The functions provide alternatives to functions that
don’t have ALTREP support. Such as <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>. Calling
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> on a sparse vector will force materialization, and
then calculate the mean. This is memory inefficient as it could have
been calculated like so.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/extractors.html">sparse_values</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>These functions, all starting with the name prefix
<code>sparse_*</code>, are made to work with non-sparse vectors for the
same reasons listed above regarding ergonomic use.</p>
</div>
<div class="section level2">
<h2 id="faq">FAQ<a class="anchor" aria-label="anchor" href="#faq"></a>
</h2>
<blockquote>
<p>Why aren’t the results returned as {vctrs} classes?</p>
</blockquote>
<p>As it stands right now, it is viewed to be beneficial to have the
users not be alerted to these vectors as they are expected to be used
internally in packages and rarely by the end user. Furthermore having
these sparse vectors produce the same result as dense vectors with
<code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> is a big plus.</p>
<blockquote>
<p>Will this package try to replace the {Matrix} package?</p>
</blockquote>
<p>Not at all. The sparse vector types provided in this package mimic
those created with <code><a href="https://rdrr.io/pkg/Matrix/man/sparseVector.html" class="external-link">Matrix::sparseVector()</a></code>. They work with
different types and allow for different defaults. None of the matrix
operations will be reimplemented here.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
